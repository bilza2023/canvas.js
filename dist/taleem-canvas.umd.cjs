(function(m,u){typeof exports=="object"&&typeof module<"u"?module.exports=u():typeof define=="function"&&define.amd?define(u):(m=typeof globalThis<"u"?globalThis:m||self,m.TaleemCanvas=u())})(this,function(){"use strict";class m{constructor(t,e,i,s){this.ctx=t,this.canvas=e,this.slideExtra=i,this.assets=s}clear(){const{ctx:t,canvas:e,slideExtra:i}=this,s=i.backgroundColor||"gray";t.clearRect(0,0,e.width,e.height),t.fillStyle=s,t.fillRect(0,0,e.width,e.height)}drawBackground(){this.slideExtra.bgGlobalAlpha||(this.slideExtra.bgGlobalAlpha=1),this.clear(),this.drawBackgroundImage(),this.slideExtra.showGrid&&this.drawGrid()}drawBackgroundImage(){const{slideExtra:t,assets:e}=this;if(t.bgImg&&e.bgImages){for(const i of e.bgImages)if(i.name===t.bgImg){this.bgImage(i.img,t.bgGlobalAlpha);break}}}bgImage(t,e=1){const{ctx:i,canvas:s}=this;i.globalAlpha=e,i.drawImage(t,0,0,s.width,s.height),i.globalAlpha=1}drawGrid(){const{ctx:t,canvas:e,slideExtra:i}=this,{cellWidth:s=100,cellHeight:a=100,gridLineWidth:r=2,gridLineColor:l="black"}=i;t.save(),t.translate(.5,.5),t.imageSmoothingEnabled=!1,t.strokeStyle=l,t.lineWidth=r;for(let h=s;h<e.width;h+=s)t.beginPath(),t.moveTo(h,0),t.lineTo(h,e.height),t.stroke();for(let h=a;h<e.height;h+=a)t.beginPath(),t.moveTo(0,h),t.lineTo(e.width,h),t.stroke();t.restore()}drawItems(t=[]){const{ctx:e,assets:i}=this;t.forEach(s=>{typeof s.draw=="function"&&s.draw(e,i)})}draw(t=[]){this.drawBackground(),this.drawItems(t)}}class u{constructor(t,e){this.canvas=t,this.items=e,this.callbacks={click:null,dblclick:null,mousedown:null,mousemove:null,mouseup:null},this.initListeners()}initListeners(){this.canvas.addEventListener("click",t=>this.handleEvent(t,"click")),this.canvas.addEventListener("dblclick",t=>this.handleEvent(t,"dblclick")),this.canvas.addEventListener("mousedown",t=>this.handleEvent(t,"mousedown")),this.canvas.addEventListener("mousemove",t=>this.handleEvent(t,"mousemove")),this.canvas.addEventListener("mouseup",t=>this.handleEvent(t,"mouseup"))}handleEvent(t,e){const i=this.canvas.getBoundingClientRect(),s=t.clientX-i.left,a=t.clientY-i.top;for(let r of this.items)r.isHit(s,a)&&this.callbacks[e]&&this.callbacks[e](t,r)}on(t,e){this.callbacks[t]!==void 0&&(this.callbacks[t]=e)}}class I{constructor(){this.callbacks={keydown:null,keyup:null},this.initListeners()}initListeners(){document.addEventListener("keydown",t=>this.handleEvent(t,"keydown")),document.addEventListener("keyup",t=>this.handleEvent(t,"keyup"))}handleEvent(t,e){this.callbacks[e]&&this.callbacks[e](t)}on(t,e){this.callbacks[t]!==void 0&&(this.callbacks[t]=e)}}class n{constructor(t={},e=[]){this.itemExtra=t,this.dialogueBox=e}static itemExtraData(){return{}}draw(t){throw new Error("draw() must be implemented by subclasses")}getBoundingRectangle(){return{x:this.boundingRectangleX(),y:this.boundingRectangleY(),width:this.boundingRectangleWidth(),height:this.boundingRectangleHeight()}}boundingRectangleX(){return this.x}boundingRectangleY(){return this.y}boundingRectangleWidth(){return this.width}boundingRectangleHeight(){return this.height}isHit(t,e){const{x:i,y:s,width:a,height:r}=this.getBoundingRectangle();return t>=i&&t<=i+a&&e>=s&&e<=s+r}get x(){return this.itemExtra.x||0}set x(t){this.itemExtra.x=t}get y(){return this.itemExtra.y||0}set y(t){this.itemExtra.y=t}get width(){return this.itemExtra.width||0}set width(t){this.itemExtra.width=t}get height(){return this.itemExtra.height||0}set height(t){this.itemExtra.height=t}set(t,e){return t in this.itemExtra?(this.itemExtra[t]=e,e):!1}align(t,e=0,i=0){if(!this.env){console.warn("Environment is not set for this item.");return}const s=n.env.getCanvasWidth(),a=n.env.getCanvasHeight();switch(t){case"top":this.x=(s-this.width)/2+e,this.y=0+i;break;case"bottom":this.x=(s-this.width)/2+e,this.y=a-this.height+i;break;case"left":this.x=0+e,this.y=(a-this.height)/2+i;break;case"right":this.x=s-this.width+e,this.y=(a-this.height)/2+i;break;case"center":this.x=(s-this.width)/2+e,this.y=(a-this.height)/2+i;break;case"top-left":this.x=0+e,this.y=0+i;break;case"top-right":this.x=s-this.width+e,this.y=0+i;break;case"bottom-left":this.x=0+e,this.y=a-this.height+i;break;case"bottom-right":this.x=s-this.width+e,this.y=a-this.height+i;break;default:console.warn(`Invalid alignment: ${t}`);break}}}function o(){const d=()=>Math.floor(Math.random()*16).toString(16);return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=d();return(t==="x"?e:e&3|8).toString(16)})}class E extends n{constructor(t){super(t||E.defaultItemExtra())}static defaultItemExtra(){return{uuid:o(),type:"rectangle",x:100,y:100,width:100,height:100,filled:!0,lineWidth:1,dash:0,gap:0,color:"red",globalAlpha:1}}draw(t,e={}){t.save(),t.lineWidth=this.itemExtra.lineWidth,t.globalAlpha=this.itemExtra.globalAlpha,this.itemExtra.dash>0||this.itemExtra.gap>0?t.setLineDash([this.itemExtra.dash,this.itemExtra.gap]):t.setLineDash([]),this.itemExtra.filled?(t.fillStyle=this.itemExtra.color,t.fillRect(this.x,this.y,this.width,this.height)):(t.strokeStyle=this.itemExtra.color,t.strokeRect(this.x,this.y,this.width,this.height)),t.restore()}}class b extends n{constructor(t){super(t||b.itemExtraData())}static itemExtraData(){return{uuid:o(),type:"circle",x:150,y:150,radius:50,startAngle:0,endAngle:2*Math.PI,lineWidth:1,dash:0,gap:0,filled:!1,color:"gray",globalAlpha:1}}boundingRectangleWidth(){return this.itemExtra.radius*2}boundingRectangleHeight(){return this.itemExtra.radius*2}boundingRectangleX(){return this.x-this.itemExtra.radius}boundingRectangleY(){return this.y-this.itemExtra.radius}get width(){return this.itemExtra.radius*2}set width(t){this.itemExtra.radius=t/2}get height(){return this.itemExtra.radius*2}set height(t){this.itemExtra.radius=t/2}draw(t,e={}){t.save(),t.lineWidth=this.itemExtra.lineWidth,t.globalAlpha=this.itemExtra.globalAlpha,t.beginPath(),t.arc(this.x,this.y,this.itemExtra.radius,this.itemExtra.startAngle,this.itemExtra.endAngle),this.itemExtra.filled?(t.fillStyle=this.itemExtra.color,t.fill()):(t.strokeStyle=this.itemExtra.color,t.stroke()),t.restore()}}class w extends n{constructor(t){super(t||w.itemExtraData())}static itemExtraData(){return{uuid:o(),type:"ellipse",x:100,y:100,radiusX:50,radiusY:75,rotation:0,startAngle:0,endAngle:2*Math.PI,lineWidth:1,filled:!1,color:"red",globalAlpha:1}}boundingRectangleWidth(){return this.itemExtra.radiusX*2}boundingRectangleHeight(){return this.itemExtra.radiusY*2}boundingRectangleX(){return this.x-this.itemExtra.radiusX}boundingRectangleY(){return this.y-this.itemExtra.radiusY}get width(){return this.itemExtra.radiusX*2}set width(t){this.itemExtra.radiusX=t/2}get height(){return this.itemExtra.radiusY*2}set height(t){this.itemExtra.radiusY=t/2}draw(t,e={}){t.save(),t.lineWidth=this.itemExtra.lineWidth,t.globalAlpha=this.itemExtra.globalAlpha,t.beginPath(),t.ellipse(this.x,this.y,this.itemExtra.radiusX,this.itemExtra.radiusY,this.itemExtra.rotation,this.itemExtra.startAngle,this.itemExtra.endAngle),this.itemExtra.filled?(t.fillStyle=this.itemExtra.color,t.fill()):(t.strokeStyle=this.itemExtra.color,t.stroke()),t.restore()}}class y extends n{constructor(t){super(t||y.itemExtraData())}static itemExtraData(){return{uuid:o(),type:"line",x1:100,y1:100,x2:300,y2:200,lineWidth:2,dash:0,gap:0,color:"blue",globalAlpha:1}}boundingRectangleWidth(){return this.width}boundingRectangleHeight(){return this.height}boundingRectangleX(){return Math.min(this.itemExtra.x1,this.itemExtra.x2)}boundingRectangleY(){return Math.min(this.itemExtra.y1,this.itemExtra.y2)}get width(){return Math.abs(this.itemExtra.x2-this.itemExtra.x1)}set width(t){this.itemExtra.x2=this.itemExtra.x1+t}get height(){return Math.abs(this.itemExtra.y2-this.itemExtra.y1)}set height(t){this.itemExtra.y2=this.itemExtra.y1+t}draw(t){t.save(),t.lineWidth=this.itemExtra.lineWidth,t.globalAlpha=this.itemExtra.globalAlpha,t.strokeStyle=this.itemExtra.color,t.setLineDash([this.itemExtra.dash,this.itemExtra.gap]),t.beginPath(),t.moveTo(this.x,this.y),t.lineTo(this.x+this.width,this.y+this.height),t.stroke(),t.restore()}}class p extends n{constructor(t){super(t||p.itemExtraData())}static itemExtraData(){return{uuid:o(),type:"ray",x1:150,y1:150,x2:350,y2:250,arrowWidth:8,arrowHeight:12,startArrow:!0,endArrow:!0,lineWidth:2,dash:0,gap:0,color:"red",globalAlpha:1}}boundingRectangleWidth(){return this.width}boundingRectangleHeight(){return this.height}boundingRectangleX(){return Math.min(this.itemExtra.x1,this.itemExtra.x2)}boundingRectangleY(){return Math.min(this.itemExtra.y1,this.itemExtra.y2)}get width(){return Math.abs(this.itemExtra.x2-this.itemExtra.x1)}set width(t){this.itemExtra.x2=this.itemExtra.x1+t}get height(){return Math.abs(this.itemExtra.y2-this.itemExtra.y1)}set height(t){this.itemExtra.y2=this.itemExtra.y1+t}draw(t){t.save(),t.lineWidth=this.itemExtra.lineWidth,t.globalAlpha=this.itemExtra.globalAlpha,t.strokeStyle=this.itemExtra.color,t.fillStyle=this.itemExtra.color,t.setLineDash([this.itemExtra.dash,this.itemExtra.gap]),t.beginPath(),t.moveTo(this.x,this.y),t.lineTo(this.x+this.width,this.y+this.height),t.stroke(),this.itemExtra.startArrow&&this.drawArrowHead(t,this.itemExtra.x2,this.itemExtra.y2,this.itemExtra.x1,this.itemExtra.y1),this.itemExtra.endArrow&&this.drawArrowHead(t,this.itemExtra.x1,this.itemExtra.y1,this.itemExtra.x2,this.itemExtra.y2),t.restore()}drawArrowHead(t,e,i,s,a){const r=Math.atan2(a-i,s-e),l=this.itemExtra.arrowWidth,h=this.itemExtra.arrowHeight;t.save(),t.translate(s,a),t.rotate(r),t.beginPath(),t.moveTo(0,0),t.lineTo(-h,l/2),t.lineTo(-h,-l/2),t.closePath(),t.fill(),t.stroke(),t.restore()}}class v extends n{constructor(t){super(t||v.itemExtraData())}static itemExtraData(){return{uuid:o(),type:"triangle",x1:100,y1:100,x2:50,y2:200,x3:200,y3:200,lineWidth:2,filled:!1,dash:0,gap:0,color:"red",globalAlpha:1}}boundingRectangleWidth(){return Math.max(this.itemExtra.x1,this.itemExtra.x2,this.itemExtra.x3)-this.boundingRectangleX()}boundingRectangleHeight(){return Math.max(this.itemExtra.y1,this.itemExtra.y2,this.itemExtra.y3)-this.boundingRectangleY()}get width(){return this.boundingRectangleWidth()}get height(){return this.boundingRectangleHeight()}boundingRectangleX(){return Math.min(this.itemExtra.x1,this.itemExtra.x2,this.itemExtra.x3)}boundingRectangleY(){return Math.min(this.itemExtra.y1,this.itemExtra.y2,this.itemExtra.y3)}get width(){return Math.max(this.itemExtra.x1,this.itemExtra.x2,this.itemExtra.x3)-this.boundingRectangleX()}get height(){return Math.max(this.itemExtra.y1,this.itemExtra.y2,this.itemExtra.y3)-this.boundingRectangleY()}draw(t){t.save(),t.lineWidth=this.itemExtra.lineWidth,t.globalAlpha=this.itemExtra.globalAlpha,t.strokeStyle=this.itemExtra.color,t.fillStyle=this.itemExtra.color,t.setLineDash([this.itemExtra.dash,this.itemExtra.gap]),t.beginPath(),t.moveTo(this.itemExtra.x1,this.itemExtra.y1),t.lineTo(this.itemExtra.x2,this.itemExtra.y2),t.lineTo(this.itemExtra.x3,this.itemExtra.y3),t.closePath(),this.itemExtra.filled&&t.fill(),t.stroke(),t.restore()}}class f extends n{constructor(t){super(t||f.itemExtraData())}static itemExtraData(){return{uuid:o(),type:"image",x:50,y:50,src:"wood.jpg",width:200,height:200,globalAlpha:1}}draw(t){t.save(),t.globalAlpha=this.itemExtra.globalAlpha;const e=this.env.assets.getImage(this.itemExtra.src),i=e?e.img:null;i?t.drawImage(i,this.x,this.y,this.width,this.height):(t.fillStyle="gray",t.fillRect(this.x,this.y,this.width,this.height),t.fillStyle="white",t.font="16px Arial",t.textAlign="center",t.fillText(`${this.itemExtra.src}: not found`,this.x+this.width/2,this.y+this.height/2)),t.restore()}boundingRectangleX(){return this.x}boundingRectangleY(){return this.y}boundingRectangleWidth(){return this.width}boundingRectangleHeight(){return this.height}}function M(){const d=()=>Math.floor(Math.random()*16).toString(16);return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=d();return(t==="x"?e:e&3|8).toString(16)})}class A extends n{constructor(t){super(t||A.itemExtraData())}static itemExtraData(){return{uuid:M(),type:"text",x:100,y:100,text:"Add text..",fontSize:30,fontFamily:"Arial",color:"black",globalAlpha:1,width:0,height:0}}draw(t,e={}){this.itemExtra.fontSize||(this.itemExtra.fontSize=40),this.itemExtra.fontFamily||(this.itemExtra.fontFamily="Arial"),t.save();const{text:i,x:s,y:a,globalAlpha:r,color:l,fontSize:h,fontFamily:g}=this.itemExtra;t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,t.globalAlpha=r,t.fillStyle=l,t.font=`${h}px ${g}`,t.textBaseline="top",t.fillText(i,s,a),t.restore()}get width(){return this.itemExtra.width===0&&(this.itemExtra.width=this.env.getTextWidth(this.itemExtra.text,this.itemExtra.fontSize,this.itemExtra.fontFamily)),this.itemExtra.width}get height(){return this.env.getTextWidth("W",this.itemExtra.fontSize,this.itemExtra.fontFamily)}boundingRectangleX(){return this.x}boundingRectangleY(){return this.y}boundingRectangleWidth(){return this.width}boundingRectangleHeight(){return this.height}set width(t){this.itemExtra.fontSize+=t/10,this.itemExtra.width=0}set height(t){this.itemExtra.fontSize+=t/10,this.itemExtra.height=0}}class c extends n{constructor(t){super(t||c.itemExtraData())}static itemExtraData(){return{uuid:o(),type:"list",x:100,y:100,listArray:["First item","Second item","Third item"],fontSize:20,fontFamily:"Arial",color:"black",lineGap:5,indentation:5,globalAlpha:1}}draw(t){t.save(),t.globalAlpha=this.itemExtra.globalAlpha,t.fillStyle=this.itemExtra.color,t.font=`${this.itemExtra.fontSize}px ${this.itemExtra.fontFamily}`;let{x:e,y:i,listArray:s,lineGap:a,indentation:r}=this.itemExtra,l=0,h=this.itemExtra.fontSize+a;s.forEach((g,x)=>{t.fillText(g,e+l,i+x*h),l+=r}),t.restore()}}class k extends n{constructor(t){super(t||k.itemExtraData())}static itemExtraData(){return{uuid:o(),type:"piechart",x:200,y:200,radius:100,data:[{label:"A",percentage:30,color:"red"},{label:"B",percentage:50,color:"blue"},{label:"C",percentage:20,color:"green"}],showLabels:!0,labelFontSize:14,labelColor:"black",globalAlpha:1}}draw(t){t.save(),t.globalAlpha=this.itemExtra.globalAlpha;let{x:e,y:i,radius:s,data:a,showLabels:r,labelFontSize:l,labelColor:h}=this.itemExtra,g=0;a.forEach(x=>{let S=x.percentage/100*2*Math.PI;if(t.beginPath(),t.moveTo(e,i),t.arc(e,i,s,g,g+S),t.closePath(),t.fillStyle=x.color,t.fill(),t.stroke(),r){let W=g+S/2,L=e+Math.cos(W)*(s*.7),C=i+Math.sin(W)*(s*.7);t.fillStyle=h,t.font=`${l}px Arial`,t.textAlign="center",t.textBaseline="middle",t.fillText(x.label,L,C)}g+=S}),t.restore()}}class R extends n{constructor(t){super(t||R.itemExtraData()),this.setDefaultSelectedItem()}static itemExtraData(){return{uuid:o(),type:"sprite",src:"unknown",selectedItem:null,width:200,height:200,globalAlpha:1}}setDefaultSelectedItem(){if(!this.env||!this.env.assets)return;const t=this.env.assets.getSprite(this.itemExtra.src);t&&t.data.length>0&&this.setSelectedItem(t.data[0].name)}getAvailableItems(){if(!this.env||!this.env.assets)return[];const t=this.env.assets.getSprite(this.itemExtra.src);return t?t.data.map(e=>e.name):[]}setSelectedItem(t){if(!this.env||!this.env.assets)return;const e=this.env.assets.getSprite(this.itemExtra.src);e&&(e.applyItem(t),this.itemExtra.selectedItem=e.selectedData)}draw(t){if(t.save(),t.globalAlpha=this.itemExtra.globalAlpha,!this.env||!this.env.assets){console.warn("Cannot draw sprite: environment or assets missing.");return}const e=this.env.assets.getSprite(this.itemExtra.src),i=e?e.img:null;if(e&&!this.itemExtra.selectedItem&&e.data.length>0&&this.setSelectedItem(e.data[0].name),i&&this.itemExtra.selectedItem){const{sx:s,sy:a,sw:r,sh:l}=this.itemExtra.selectedItem;t.drawImage(i,s,a,r,l,this.x,this.y,this.width,this.height)}else t.fillStyle="gray",t.fillRect(this.x,this.y,this.width,this.height),t.fillStyle="white",t.font="16px Arial",t.textAlign="center",t.fillText(`${this.itemExtra.src}: not found`,this.x+this.width/2,this.y+this.height/2);t.restore()}}class D{constructor(t,e){this.items=t,this.env=e}sprite(){const t=new R;return t.env=this.env,this.items.push(t),t}piechart(){const t=new k;return t.env=this.env,this.items.push(t),t}list(){const t=new c;return t.env=this.env,this.items.push(t),t}list(){const t=new c;return t.env=this.env,this.items.push(t),t}rectangle(){const t=new E;return t.env=this.env,this.items.push(t),t}circle(){const t=new b;return t.env=this.env,this.items.push(t),t}ellipse(){const t=new w;return t.env=this.env,this.items.push(t),t}line(){const t=new y;return t.env=this.env,this.items.push(t),t}ray(){const t=new p;return t.env=this.env,this.items.push(t),t}triangle(){const t=new v;return t.env=this.env,this.items.push(t),t}image(){const t=new f;return t.env=this.env,this.items.push(t),t}text(){const t=new A;return t.env=this.env,this.items.push(t),t}}class T{constructor(t,e){this.ctx=t,this.assets=e}getAssets(){return this.assets}getTextWidth(t,e,i){return this.ctx.font=`${e}px ${i}`,this.ctx.measureText(t).width}getCanvasWidth(){return this.ctx.canvas.width}getCanvasHeight(){return this.ctx.canvas.height}}class H{constructor(t,e={},i=1e3,s=360){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.width=i,this.height=s,this.canvas.width=this.width,this.canvas.height=this.height,this.items=[];const a=new T(this.ctx,e);this.add=new D(this.items,a),this.drawModule=new m(this.ctx,this.canvas,{},{}),this.eventModule=new u(this.canvas,this.items),this.inputModule=new I}addItem(t){this.items.push(t),this.drawModule.draw(this.items)}onMouse(t,e){this.eventModule.on(t,e)}onKey(t,e){this.inputModule.on(t,e)}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}draw(){this.clear(),this.drawModule.draw(this.items)}}return H});
